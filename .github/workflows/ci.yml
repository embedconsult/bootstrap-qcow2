name: Crystal CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Crystal 1.18.2
        uses: crystal-lang/install-crystal@v1
        with:
          crystal: 1.18.2

      - name: Install shards
        run: shards install --skip-postinstall

      - name: Check formatting
        run: crystal tool format --check

      - name: Run specs
        run: crystal spec

      - name: Smoke test sysroot builder (local-only)
        run: |
          crystal eval '
            require "./src/sysroot_builder"
            require "file_utils"
            require "process"
            require "path"

            workspace = Path["/tmp/sysroot-ci"]
            FileUtils.rm_rf(workspace)
            FileUtils.mkdir_p(workspace / "tarroot")
            File.write(workspace / "tarroot/etc.txt", "config")
            miniroot_tar = workspace / "miniroot.tar"
            status = Process.run("tar", ["-cf", miniroot_tar.to_s, "-C", (workspace / "tarroot").to_s, "."])
            raise "tar failed: #{status.exit_code}" unless status.success?

            class StubBuilder < Bootstrap::SysrootBuilder
              def initialize(@stub_tar : Path, workspace : Path)
                super(workspace)
              end

              def packages : Array(Bootstrap::SysrootBuilder::PackageSpec)
                [] of Bootstrap::SysrootBuilder::PackageSpec
              end

              def download_and_verify(pkg : Bootstrap::SysrootBuilder::PackageSpec) : Path
                @stub_tar
              end
            end

            builder = StubBuilder.new(miniroot_tar, workspace)
            builder.prepare_rootfs(builder.minirootfs_spec)
            output = workspace / "chroot.tar.gz"
            builder.generate_chroot_tarball(output)
            raise "missing chroot tarball" unless File.exists?(output)
            puts "Generated chroot tarball at #{output}"
          '
